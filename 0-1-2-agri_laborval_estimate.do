use "${gsdTemp}/sublocations_censusdata.dta",clear 
gen survey=1
gen crop_animalprod=(H19_1==1 | H19_2==1 | H19_3==1 | H25==1)
preserve 
*Preprocess the household member level dataset from KCHS 2021 (used for income imputation into the census)
use "${gsdDataRaw}\kchs 2021\KCHS 2021 individuals_microdata.dta", clear 
drop crop_animalprod cincome income ln_income
gen crop_animalprod=inrange(d23_isic,  111,  322) //Flag workers in Agriculture
lab var crop_animalprod "ISIC code, Rev. 4 - section-level"
*Monthly Income for casual labourers --> Daily wage * days worked in last month
gen cincome=d38*d39 
egen income=rowtotal(d48_amount cincome),m //total of employment and casual income
//outdetect income, replace force small non noz //remove outliers 
bys crop_animalprod: egen median_income=median(income) //by replacing them with agriculture specific median
//replace income=median_income if inlist(_out,1,2)
summ income
drop median_income
tempfile kchs_2021_hhm
qui save `kchs_2021_hhm', replace 
restore 
append using `kchs_2021_hhm'
replace survey=2 if mi(survey)
lab def survey 1 "Census 2019" 2 "KCHS 2021"
lab val survey survey
*Create regressors for income imputation: 
replace b03=P10 if !mi(P10) & mi(b03)
gen hh_head=b03==1 //1. household head status
//2. age category
replace b05_years=P12 if !mi(P12) & mi(b05_years)
recode b05_years (15/25=1) (26/45=2) (46/65=3) (66/100=4),gen(age_category) 
//3. gender
replace b04=P11 if !mi(P11) & mi(b04)
gen female=b04==2 
//4. person is in a relationship
replace b07=P18 if !mi(P18) & mi(b07)
gen couple_status=inlist(b07,1,2,3) 
//5. person has education
replace c06=P18 if !mi(P46) & mi(c06)
gen educated=c06>=13 
*Get predicted income 
gen ln_income=ln(income) //enter log space for the prediction
xi: vselect ln_income hh_head age_category female couple_status educated hhsize, forward aicc //select best model
qui predict ln_income_hat, xb //predict income for census
replace ln_income_hat=. if !inlist(b05_years,15,65)
gen income_imp=exp(ln_income_hat) //exit log space 
label var income_imp "Imputed income for all households"
gen income_value_y=income_imp*12*10/$usd_ksh //we have only 10% of the sample, hence need to multiply by 10. also, multiply the monthly income by 12 and transform into USD terms
keep if survey==1 //only keep the census 
keep if crop_animalprod==1
collapse (sum) income_value_y (sum) n_ppl_agric=crop_animalprod,by(objectid_1) //sum the yearly income from agriculture for all inhabitants of each sublocation
replace n_ppl_agric=n_ppl_agric*10
qui save "${gsdTemp}\benefit_income_bysublocations.dta", replace 